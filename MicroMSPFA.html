<!DOCTYPE html>
<html>
	<head>
		<title>MicroMSPFA</title>
		<meta charset="utf-8">
		<script>
		</script>
		<script src="data/pages.js"></script>
		<script>
			let currentPage = 0;

			addEventListener('load', (event) => {
				updatePageToFragment();
			});

			addEventListener('hashchange', (event) => {
				updatePageToFragment();
			});
			addEventListener('keydown', (event) => {
				if (event.repeat) return;
				if (event.altKey || event.ctrlKey || event.metaKey) return;
				if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
				switch (event.key) {
					case 'ArrowRight':
						advancePage();
						break;
					case 'ArrowLeft':
						regressPage();
						break;
					case ' ':
						const logs = document.querySelectorAll('.log summary');
						for (let i = 0; i < logs.length; i++) {
							logs[i].click();
						}
						break;
				}
			});

			function updatePageToFragment() {
				const jumpToPage = parseInt(window.location.hash.substring(2));
				currentPage = (isNaN(jumpToPage) ? 0 : jumpToPage - 1);
				displayPage();
			}

			function displayPage() {
				window.scrollTo(0, 0);
				document.querySelector('.mediaContent .pageTitle').innerHTML = htmlEscape(pages[currentPage].title)

				let midPanelsCount = 0;
				const textContentData = pages[currentPage].content ?? [];
				for (let i = 0; i < textContentData.length; i++) {
					if (textContentData[i].type == 'panel') {
						midPanelsCount++;
					}
				}

				const panelsHTML = [];
				if (pages[currentPage].soundPage) {
					document.querySelector('.mediaContent .media').innerHTML = `<video controls width="650"><source src="data/images/panels/${ pages[currentPage].soundPage }"></video>`;
				} else {
					let panelFilenames = [];
					if (pages[currentPage].panels == null) {
						const panelCount = pages[currentPage].panelCount ?? 1;
						for (let i = 0; i < panelCount; i++) {
							panelFilenames[i] = (currentPage+1).toString().padStart(5, '0') + (panelCount > 1 ? '_' + (i+1) : '') + '.gif';
						}
					} else {
						let panelsList = pages[currentPage].panels;
						if (!Array.isArray(panelsList)) panelsList = [panelsList];
						panelFilenames = panelsList;
					}
					midPanelsCount = Math.min(midPanelsCount, panelFilenames.length);

					let panelAltText = [];
					if (pages[currentPage].altText != null) {
						if (typeof pages[currentPage].altText === 'string') {
							panelAltText = [pages[currentPage].altText];
						} else {
							panelAltText = pages[currentPage].altText;
						}
					}
					for (let i = 0; i < panelFilenames.length; i++) {
						panelsHTML[i] = `<img src="data/images/panels/${ panelFilenames[i] }" ${ panelAltText[i] ? 'alt="' + htmlEscape(panelAltText[i]) + '"' : '' } class=panel>`;
					}
					document.querySelector('.mediaContent .media').innerHTML = panelsHTML.slice(0, panelFilenames.length - midPanelsCount).join('');
				}

				let textContent = '';
				let midPanelIndex = panelsHTML.length - midPanelsCount;
				for (let i = 0; i < textContentData.length; i++) {
					switch (textContentData[i].type) {
						default:
						case 'prattle':
							textContent += `<p class=prattle>${ textContentData[i].text }</p>`;
							break;
						case 'panel':
							textContent += panelsHTML[midPanelIndex];
							midPanelIndex++;
							break;
						case 'authorlog':
							textContent += `<div class=authorlog><p class=logContent>${ textContentData[i].text }</p></div>`;
							break;
						case 'log':
							const logType = textContentData[i].logType ?? 'Pesterlog';
							const hideText = textContentData[i].hideText ?? 'Hide ' + logType;
							const showText = textContentData[i].showText ?? 'Show ' + logType;
							textContent += `<details class=log><summary onclick="setLogButtonText(this, '${ stringEscape(hideText) }', '${ stringEscape(showText) }')">${ showText }</summary><p class=logContent>${ textContentData[i].text }</p></details>`;
							break;
						case 'credit':
							textContent += `<div class="creditWrapper"><a target="_blank" rel="noopener noreferrer" href="${ textContentData[i].link ?? '' }" class="frame"><span class="icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="music" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="svg-inline--fa fa-music"><path data-v-03df3002="" fill="currentColor" d="M499.1 6.3c8.1 6 12.9 15.6 12.9 25.7v72V368c0 44.2-43 80-96 80s-96-35.8-96-80s43-80 96-80c11.2 0 22 1.6 32 4.6V147L192 223.8V432c0 44.2-43 80-96 80s-96-35.8-96-80s43-80 96-80c11.2 0 22 1.6 32 4.6V200 128c0-14.1 9.3-26.6 22.8-30.7l320-96c9.7-2.9 20.2-1.1 28.3 5z" class=""></path></svg></span><div class="credit"><span class="marquee">${ textContentData[i].text }</span></div></a></div>`;
							break;
						case 'password':
							textContent += `<div class="password">${ textContentData[i].text ? `<label for="password${ i }">${ textContentData[i].text }</label>` : '' }<input class="passwordBox" id="password${ i }" type="text" onkeypress="if (event.key == 'Enter') {checkPassword(${ i })}"><input id="password${ i }-submit" type="button" value="Submit" onclick="checkPassword(${ i })"></div>`;
							break;
					}
				}
				textContent += '<nav>';
				if (currentPage < pages.length - 1 && !pages[currentPage].noNextButton) textContent += `<div class="nextArrow">&gt; <a href="#p${ currentPage+2 }">${ htmlEscape(pages[currentPage+1].title) }</a></div>`;
				if (currentPage > 0) textContent += `<div class=footerNav><ul class=navOptions><li><a href="#p1" class=startOver>Start Over</a></li><li><a href="#p${ currentPage }" class=goBack>Go Back</a></li></ul></div>`;
				textContent += '</nav>';
				document.querySelector('.textContent').innerHTML = textContent;
			}

			function advancePage() {
				if (currentPage >= pages.length - 1) return;
				if (pages[currentPage].noNextButton) return;
				currentPage++;
				updatePage();
			}

			function regressPage() {
				if (currentPage <= 0) return;
				currentPage--;
				updatePage();
			}

			function updatePage() {
				window.location.hash = 'p' + (currentPage + 1);
			}

			// Called from events
			function setLogButtonText(button, showText, hideText) {
				button.innerHTML = button.parentElement.open ? hideText : showText;
			}

			function checkPassword(contentIndex) {
				const passwordPages = pages[currentPage].content[contentIndex].passwordPages ?? {};
				const input = document.querySelector('#password' + contentIndex).value.toLowerCase();
				for (const key in passwordPages) {
					if (input == key.toLowerCase()) {
						currentPage = passwordPages[key] - 1;
						updatePage();
						break;
					}
				}
			}

			// Utilities
			function stringEscape(str) {
				return str.replaceAll('\\', '\\\\').replaceAll('"', '\\"').replaceAll("'", "\\'");
			}
		</script>
		<style>
			body, div, h1, h2, h3, h4, h5, h6, li, ol, p, ul {
				margin: 0;
				padding: 0;
			}
			body {
				font-family: Courier New,courier,monospace;
				font-size: 14px;
				font-weight: bolder;
				overflow-wrap: break-word;
				background: #535353;
				margin: 0;
				padding: 0;
				display: flex;
				flex: 1 0 auto;
				flex-flow: column;
				align-items: center;
				overflow-x: hidden;
			}
			.pageFrame {
				background: #C6C6C6;
				width: 950px;
				/* padding-top: 7px; */
				padding-top: 23px;
				padding-bottom: 23px;
				margin: auto 0;
				position: relative;
				flex: 0 1 auto;
				display: flex;
				justify-content: center;
			}
			.pageContent {
				background: #EEE;
				width: 650px;
				display: flex;
				flex: 0 1 auto;
				align-items: center;
				flex-flow: column;
			}
			.mediaContent {
				display: flex;
				align-items: center;
				flex-flow: column;
			}
			.media {
				display: flex;
				align-items: center;
				flex-flow: column;
			}
			/*.pageFrame .pageContent .mediaContent .media .panel:not(:last-child) {*/
			.panel:has( + .panel) {
				margin-bottom: 20px;
			}
			.pageTitle {
				max-width: 590px;
				text-align: center;
				line-height: 1.1;
				font-size: 32px; padding: 15px 0;
			}
			img {
				/* Cross-browser compatability */
				image-rendering: -moz-crisp-edges;
				image-rendering: -o-crisp-edges;
				image-rendering: -webkit-optimize-contrast;
				image-rendering: pixelated;
				image-rendering: crisp-edges;
				-ms-interpolation-mode: nearest-neighbor;
			}
			.textContent {
				margin-top: 30px;
				display: flex;
				flex-direction: column;
			}
			.textContent > :not(.panel, .creditWrapper) {
				margin-left: calc((650px - 600px) / 2);
				margin-right: calc((650px - 600px) / 2);
			}
			.textContent > .panel + :not(.panel) {
				margin-top: 30px;
			}
			.prattle {
				width: 600px;
				max-width: 100%;
				text-align: center;
				margin: 0 0 30px 0;
				font-size: 1.3em;
				line-height: 1.15;
			}
			nav {
				display: block;
			}
			.nextArrow {
				margin: 0 0 30px 0;
				font-family: Verdana,Arial,Helvetica,sans-serif;
				font-size: x-large;
				font-weight: 400;
				color: #000;
			}
			a {
				color: #00E;
			}
			.footerNav {
				overflow: hidden;
				display: flex;
				justify-content: space-between;
				line-height: 10px;
			}
			.footerNav ul {
				list-style: none;
				font-size: 10px;
				font-family: Verdana,Arial,Helvetica,sans-serif;
			}
			.navOptions {
				color: #000;
			}
			.footerNav ul li {
				float: left;
				padding-bottom: 15px;
			}
			.footerNav ul li:not(:last-child):after {
				content: "|";
				margin: 0 .3em;
			}
			.log {
				width: 600px;
				max-width: 100%;
				margin: 0 0 30px 0;
				border: 1px dashed grey;
				background: #EEE;
				padding: 1px;
				text-align: center;
				align-self: center;
				position: relative;
			}
			.log summary {
				-webkit-appearance: button;
				-webkit-writing-mode: horizontal-tb !important;
				text-rendering: auto;
				color: #000;
				letter-spacing: normal;
				word-spacing: normal;
				text-transform: none;
				text-indent: 0px;
				text-shadow: none;
				display: inline-block;
				text-align: center;
				align-items: flex-start;
				cursor: default;
				background-color: rgb(239, 239, 239);
				box-sizing: border-box;
				margin: 0em;
				font: 400 13.3333px Arial;
				padding: 1px 6px;
				border-radius: 2px;
				border-width: 1px;
				border-style: solid;
				border-color: rgb(118, 118, 118);
				border-image: initial;

				user-select: none;
			}
			.log summary:hover {
				background: #E5E5E5;
			}
			.log summary:active {
				background: #F5F5F5;
			}
			button, input {
				font: 400 13.3333px Arial;
			}
			:focus {
				outline: none;
			}
			.logContent {
				margin: 0;
				color: #000;
				padding: 15px 5%;
				text-align: left;
				position: inherit;
				z-index: 1;
				font-weight: 700;
				font-size: 1.3em;
				line-height: 1.15;
				white-space: preserve;
			}
			.authorlog {
				width: 600px;
				box-sizing: border-box;
				margin: 0 0 30px 0;
				text-align: left;
				border: 3px solid #c6c6c6;
				background: white;
			}
			.creditWrapper {
				width: -moz-min-content;
				width: min-content;
				/*max-width: 100%;*/
				max-width: 600px;
				margin: 0 auto 30px;
				padding: 2px;
				background-color: #ff9000;
				border: 2px solid #ff9000;
				transition: opacity 1s;
			}
			.frame {
				display: flex;
				text-decoration: none;
				color: #fff;
			}
			a.frame {
				color: #fff!important;
			}
			.icon {
				font-size: 14px;
				background: #000;
				border: 2px solid #ff0;
				margin-right: 4px;
				padding: 4px;
				line-height: 0;
			}
			.credit {
				font-size: 14px;
				line-height: 1.6;
				overflow: hidden;
				white-space: nowrap;
				width: 100%;
				padding: 0 5px;
				background: #000;
				border: 2px solid #ff0;
				box-shadow: 0 0 0 2px #ff9000;
			}
			.credit .marquee {
				display: inline-block;
			}
			svg:not(:root).svg-inline--fa, svg:not(:host).svg-inline--fa {
				overflow: visible;
				box-sizing: content-box;
			}
			.svg-inline--fa {
				display: var(--fa-display, inline-block);
				height: 1em;
				overflow: visible;
				vertical-align: -0.125em;
			}
			.password {
				text-align: center;
				margin: 0 0 30px 0;
			}
			.password > label {
				display: block;
				font-size: 1.3em;
				line-height: 1.15;
			}
			.passwordBox {
				margin-right: 3px;
			}
			.footer {
				height: 110px;
				max-width: 100vw;
				box-sizing: border-box;
				padding-left: 12px;
				padding-right: 12px;
				display: flex;
				justify-content: space-between;
				align-items: center;
				-webkit-user-select: none;
				-moz-user-select: none;
				user-select: none;
			}
		</style>
	</head>
	<body>
		<div class=pageFrame>
			<div class=pageContent>
				<div class=mediaContent>
					<h2 class=pageTitle></h2>
					<div class=media>
					</div>
				</div>
				<div class=textContent>
				</div>
			</div>
		</div>
		<div class="footer mspa" style="width: 950px;">
			<img src="data/images/mspalogo.png" class="mediaembed bannerImage left" draggable="false"><!--
			--><img src="data/images/mspalogo.png" class="mediaembed bannerImage right" draggable="false">
		</div>
	</body>
</html>
